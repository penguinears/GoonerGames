<script>
let handOn = false;

const introPage=document.getElementById('introPage');
const gamePage=document.getElementById('gamePage');
function goToGame(){introPage.classList.remove('active');gamePage.classList.add('active');playGame();}
function goToIntro(){gamePage.classList.remove('active');introPage.classList.add('active');location.reload();}

let round=0,running=false;
const lightIndicator=document.getElementById('lightIndicator');
const roundNum=document.getElementById('roundNum');
const timeLeft=document.getElementById('timeLeft');
const statusText=document.getElementById('statusText');
const lastResult=document.getElementById('lastResult');
const handDisplay=document.getElementById('handDisplay');
const resetBtn=document.getElementById('resetBtn');
const playBtn=document.getElementById('playBtn');

// --- Only set handOn when pressing the square ---
handDisplay.addEventListener('mousedown', ()=>{ handOn=true; updateHandDisplay(); });
handDisplay.addEventListener('mouseup', ()=>{ handOn=false; updateHandDisplay(); });
handDisplay.addEventListener('touchstart', e=>{ e.preventDefault(); handOn=true; updateHandDisplay(); });
handDisplay.addEventListener('touchend', e=>{ e.preventDefault(); handOn=false; updateHandDisplay(); });

// Keyboard fallback for desktop
document.addEventListener('keydown', e=>{ if(e.code==='Space'){ handOn=true; updateHandDisplay(); }});
document.addEventListener('keyup', e=>{ if(e.code==='Space'){ handOn=false; updateHandDisplay(); }});

function setIndicator(state){
  if(state==='red'){
    lightIndicator.className='indicator red';
    lightIndicator.textContent='RED â€“ Keep gooning hand ON the square';
  } else {
    lightIndicator.className='indicator green';
    lightIndicator.textContent='GREEN â€“ Take your hand OFF';
  }
}

function updateHandDisplay(){
  handDisplay.style.backgroundColor = handOn ? 'rgba(43,215,123,0.6)' : 'rgba(0,0,0,0.2)';
  handDisplay.textContent = handOn ? "âœ‹ Gooning" : "ðŸ–ï¸ Off";
}

async function playGame(){
  if(running) return;
  running=true;
  round=0;
  statusText.textContent='Playing';
  lastResult.textContent='';

  while(running){
    round++;
    roundNum.textContent=round;

    // RED light: must hold for 3s
    setIndicator('red');
    let redTime=3;
    for(let i=redTime;i>0;i--){
      timeLeft.textContent=i;
      updateHandDisplay();
      if(!handOn){
        running=false;
        statusText.textContent='Failed';
        statusText.className='status-bad';
        lastResult.textContent=`Lost round ${round} (not holding during RED)`;
        return;
      }
      await new Promise(r=>setTimeout(r,1000));
    }

    // GREEN light: random 2â€“3s
    setIndicator('green');
    let greenTime=2+Math.floor(Math.random()*2);
    for(let i=greenTime;i>0;i--){
      timeLeft.textContent=i;
      updateHandDisplay();
      if(handOn){
        running=false;
        statusText.textContent='Failed';
        statusText.className='status-bad';
        lastResult.textContent=`Lost round ${round} (still holding during GREEN)`;
        return;
      }
      await new Promise(r=>setTimeout(r,1000));
    }

    statusText.textContent='Safe';
    statusText.className='status-ok';
    lastResult.textContent=`Survived round ${round}`;
  }
}

resetBtn.addEventListener('click',()=>{location.reload();});
playBtn.addEventListener('click',()=>{goToGame();});
</script>
